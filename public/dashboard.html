<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - n8n DFY Autopilot</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
        }
        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .request-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .request-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .request-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .request-description {
            color: #6c757d;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid #007bff;
            color: #007bff;
        }
        .btn-outline:hover {
            background: #007bff;
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .search-bar {
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 16px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination .active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1>Welcome to Your Dashboard</h1>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalRequests">-</span>
                    <span class="stat-label">Total Requests</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="completedWorkflows">-</span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="processingWorkflows">-</span>
                    <span class="stat-label">In Progress</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalSpent">$-</span>
                    <span class="stat-label">Total Spent</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Recent Requests -->
            <div class="dashboard-card" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h2 class="card-title">Your Workflow Requests</h2>
                    <button class="btn btn-primary" onclick="window.location.href='/#request-form'">
                        New Request
                    </button>
                </div>
                
                <div class="search-bar">
                    <input type="text" 
                           class="search-input" 
                           id="searchInput" 
                           placeholder="Search your requests..."
                           onkeyup="filterRequests()">
                </div>

                <div id="requestsContainer">
                    <div class="loading">Loading your requests...</div>
                </div>

                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prevBtn" onclick="changePage(-1)">Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextBtn" onclick="changePage(1)">Next</button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" onclick="window.location.href='/#request-form'">
                        Request New Workflow
                    </button>
                    <button class="btn btn-outline" onclick="downloadAllWorkflows()">
                        Download All Workflows
                    </button>
                    <button class="btn btn-outline" onclick="window.location.href='/support'">
                        Contact Support
                    </button>
                </div>
            </div>

            <!-- Account Info -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">Account Information</h3>
                </div>
                <div id="accountInfo">
                    <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
                    <p><strong>Member Since:</strong> <span id="memberSince">Loading...</span></p>
                    <p><strong>Total Workflows:</strong> <span id="workflowCount">Loading...</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h3>Complete Payment</h3>
            <div id="paymentForm">
                <div id="card-element" style="padding: 20px; border: 1px solid #ccc; border-radius: 5px; margin: 20px 0;"></div>
                <div id="card-errors" style="color: #fa755a; margin-top: 10px;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="submitPayment" class="btn btn-success">Pay Now</button>
                    <button onclick="closePaymentModal()" class="btn btn-outline">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Dashboard state
        let currentPage = 1;
        let totalPages = 1;
        let allRequests = [];
        let filteredRequests = [];
        const pageSize = 10;

        // Stripe configuration
        const stripe = Stripe('pk_test_your_publishable_key_here'); // Replace with actual key
        const elements = stripe.elements();
        let cardElement;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeStripe();
            loadDashboardData();
            setInterval(refreshData, 30000); // Refresh every 30 seconds
        });

        function initializeStripe() {
            cardElement = elements.create('card');
            cardElement.mount('#card-element');
            
            cardElement.addEventListener('change', ({error}) => {
                const displayError = document.getElementById('card-errors');
                if (error) {
                    displayError.textContent = error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }

        async function loadDashboardData() {
            try {
                const email = getCustomerEmail();
                if (!email) {
                    window.location.href = '/#request-form';
                    return;
                }

                await Promise.all([
                    loadCustomerRequests(email),
                    loadAccountInfo(email),
                    loadStatistics(email)
                ]);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        async function loadCustomerRequests(email) {
            try {
                const response = await fetch(`/api/v1/customers/requests?email=${email}&page=${currentPage}&limit=${pageSize}`);
                const data = await response.json();
                
                allRequests = data.requests || [];
                filteredRequests = [...allRequests];
                totalPages = data.pagination?.totalPages || 1;
                
                renderRequests();
                updatePagination();
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsContainer').innerHTML = 
                    '<div class="empty-state">Failed to load requests</div>';
            }
        }

        async function loadAccountInfo(email) {
            // Mock account info - replace with actual API call
            document.getElementById('userEmail').textContent = email;
            document.getElementById('memberSince').textContent = new Date().toLocaleDateString();
            document.getElementById('workflowCount').textContent = allRequests.length;
        }

        async function loadStatistics(email) {
            const totalRequests = allRequests.length;
            const completedWorkflows = allRequests.filter(r => r.status === 'completed').length;
            const processingWorkflows = allRequests.filter(r => r.status === 'processing' || r.status === 'paid').length;
            const totalSpent = allRequests.reduce((sum, r) => sum + (r.estimated_price || 0), 0);

            document.getElementById('totalRequests').textContent = totalRequests;
            document.getElementById('completedWorkflows').textContent = completedWorkflows;
            document.getElementById('processingWorkflows').textContent = processingWorkflows;
            document.getElementById('totalSpent').textContent = totalSpent.toFixed(2);
        }

        function renderRequests() {
            const container = document.getElementById('requestsContainer');
            
            if (filteredRequests.length === 0) {
                container.innerHTML = '<div class="empty-state">No requests found</div>';
                return;
            }

            const requestsHtml = filteredRequests.map(request => `
                <div class="request-item">
                    <div class="request-meta">
                        <strong>Request #${request.id}</strong>
                        <span class="status-badge status-${request.status}">${request.status}</span>
                    </div>
                    <div class="request-description">
                        ${request.automation_description.substring(0, 150)}${request.automation_description.length > 150 ? '...' : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0;">
                        <div><strong>Industry:</strong> ${request.industry || 'Not specified'}</div>
                        <div><strong>Complexity:</strong> ${request.complexity || 'Medium'}</div>
                        <div><strong>Price:</strong> $${request.estimated_price || 'TBD'}</div>
                        <div><strong>Created:</strong> ${new Date(request.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="action-buttons">
                        ${getActionButtons(request)}
                    </div>
                </div>
            `).join('');

            container.innerHTML = requestsHtml;
        }

        function getActionButtons(request) {
            let buttons = [];
            
            switch(request.status) {
                case 'quoted':
                    buttons.push(`<button class="btn btn-success" onclick="initiatePayment(${request.id})">Pay Now</button>`);
                    break;
                case 'paid':
                case 'processing':
                    buttons.push(`<button class="btn btn-outline" onclick="checkStatus(${request.id})">Check Status</button>`);
                    break;
                case 'completed':
                    buttons.push(`<button class="btn btn-primary" onclick="downloadWorkflow(${request.id})">Download</button>`);
                    buttons.push(`<button class="btn btn-outline" onclick="viewTutorial(${request.id})">View Tutorial</button>`);
                    break;
            }
            
            buttons.push(`<button class="btn btn-outline" onclick="viewDetails(${request.id})">View Details</button>`);
            
            return buttons.join('');
        }

        function filterRequests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredRequests = allRequests.filter(request => 
                request.automation_description.toLowerCase().includes(searchTerm) ||
                request.industry?.toLowerCase().includes(searchTerm) ||
                request.status.toLowerCase().includes(searchTerm)
            );
            renderRequests();
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadCustomerRequests(getCustomerEmail());
            }
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');

            if (totalPages > 1) {
                pagination.style.display = 'flex';
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            } else {
                pagination.style.display = 'none';
            }
        }

        async function initiatePayment(requestId) {
            try {
                const request = allRequests.find(r => r.id === requestId);
                const response = await fetch('/api/v1/payments/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        customer_email: request.customer_email,
                        amount: request.estimated_price
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showPaymentModal(data.client_secret, requestId);
                } else {
                    showError(data.message || 'Failed to initiate payment');
                }
            } catch (error) {
                console.error('Error initiating payment:', error);
                showError('Failed to initiate payment');
            }
        }

        function showPaymentModal(clientSecret, requestId) {
            document.getElementById('paymentModal').style.display = 'block';
            
            const submitButton = document.getElementById('submitPayment');
            submitButton.onclick = () => confirmPayment(clientSecret, requestId);
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        async function confirmPayment(clientSecret, requestId) {
            const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: cardElement,
                }
            });

            if (error) {
                document.getElementById('card-errors').textContent = error.message;
            } else {
                showSuccess('Payment successful! Your workflow generation will begin shortly.');
                closePaymentModal();
                setTimeout(() => loadDashboardData(), 2000);
            }
        }

        async function downloadWorkflow(requestId) {
            try {
                const response = await fetch(`/api/v1/workflows/${requestId}/download`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `workflow-${requestId}.json`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    showError('Download not available yet');
                }
            } catch (error) {
                console.error('Error downloading workflow:', error);
                showError('Failed to download workflow');
            }
        }

        async function viewTutorial(requestId) {
            try {
                const response = await fetch(`/api/v1/content/${requestId}/video-url`);
                const data = await response.json();
                if (response.ok && data.youtube_url) {
                    window.open(data.youtube_url, '_blank');
                } else {
                    showError('Tutorial video not available yet');
                }
            } catch (error) {
                console.error('Error opening tutorial:', error);
                showError('Failed to open tutorial');
            }
        }

        function viewDetails(requestId) {
            const request = allRequests.find(r => r.id === requestId);
            alert(`Request Details:\n\nID: ${request.id}\nStatus: ${request.status}\nComplexity: ${request.complexity}\nPrice: $${request.estimated_price}\nCreated: ${new Date(request.created_at).toLocaleString()}\n\nDescription:\n${request.automation_description}`);
        }

        async function downloadAllWorkflows() {
            try {
                const completedRequests = allRequests.filter(r => r.status === 'completed');
                if (completedRequests.length === 0) {
                    showError('No completed workflows to download');
                    return;
                }

                showSuccess(`Starting download of ${completedRequests.length} workflows...`);
                
                for (const request of completedRequests) {
                    await downloadWorkflow(request.id);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Delay between downloads
                }
            } catch (error) {
                console.error('Error downloading all workflows:', error);
                showError('Failed to download all workflows');
            }
        }

        function getCustomerEmail() {
            return localStorage.getItem('customerEmail') || 
                   new URLSearchParams(window.location.search).get('email') ||
                   prompt('Please enter your email to access the dashboard:');
        }

        function refreshData() {
            loadDashboardData();
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }

        function checkStatus(requestId) {
            refreshData();
            showSuccess('Status updated! Check the request for latest information.');
        }
    </script>
</body>
</html>